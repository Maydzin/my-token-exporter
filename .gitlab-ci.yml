---
include:
  - project: "adas/devops/images/common-ci"
    ref: "master"
    file: "/main.yml"
  - project: 'adas/devops/gitlab-remote-includes'
    ref: master
    file:
      - '/templates/helm.yml'
  - project: 'adas/software/dataplatform/templates/dataplatform-helm'
    ref: master
    file:
    - 'helm-dataplatform.yml'


stages:
  - "lint"
  - "build"
  - "scan"
  - "diff"
  - "deploy"
  - "rollback"

variables:
  DEPLOY_IMAGE_NAME: "gitlab-token-exporter"
  DEPLOY_PROJECT_NAME: "infra"
  DEPLOY_IMAGE_REGISTRY: "${DOCKER_REGISTRY}"
  GITLAB_URL: "https://gitlab.int.e-kama.com"
  GROUP_ID: "160"
  ACCESS_TOKEN: "$ACCESS_TOKEN" 
  # Переменные для Kubeconfig
  KUBE_CONFIG_BASE64: "$KUBECONFIG_ADAS_INFRA_INT"
  KUBE_NAMESPACE: "gitlab-token-exporter"
  # Переменные для Helm
  HELM_IS_USE_LOCAL_REPO: "true"
  HELM_VALUES_FILE: "${CI_PROJECT_DIR}/.helm/values.yaml"
  HELM_RELEASE_NAME: "gitlab-token-exporter"
  HELM_SET: ""
  DEPLOY_IMAGE_TAG: "latest"

before_script: []

.build:release-image:
  stage: build
  variables:
    DEPLOY_IMAGE_TAG: "${CI_COMMIT_TAG}"
  rules:
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - when: never

.build:test-image:
  stage: build
  rules:
    - if: '$CI_COMMIT_TAG'
      when: never

check-dockle:
  stage: scan
  variables:
    DEPLOY_IMAGE_TAG: "${CI_COMMIT_TAG}"
  rules:
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - when: never

scan-trivy:
  stage: scan
  variables:
    DEPLOY_IMAGE_TAG: "${CI_COMMIT_TAG}"
  rules:
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - when: never

lint::infra-common:
  stage: lint
  extends: .helm_lint

diff::infra-common:
  stage: diff
  before_script:
    - echo "${KUBE_CONFIG_BASE64}" | base64 -d > kubeconfig
    - export KUBECONFIG=$CI_PROJECT_DIR/kubeconfig
    - helm plugin install https://github.com/databus23/helm-diff
  extends: .helm_diff

.helm_deploy:
  stage: deploy
  before_script:
    - echo "${KUBE_CONFIG_BASE64}" | base64 -d > kubeconfig
    - export KUBECONFIG=$CI_PROJECT_DIR/kubeconfig
  script:
    >-
      if [ "${HELM_IS_USE_LOCAL_REPO}" = "true" ]; then
        helm upgrade --install $HELM_RELEASE_NAME $HELM_DIR
        --namespace $KUBE_NAMESPACE --create-namespace $HELM_SET
      else
        helm repo add $HELM_REPO_NAME $HELM_REPO_URL
        && helm upgrade --install -f $HELM_VALUES_FILE $HELM_RELEASE_NAME $HELM_CHART
        --namespace $KUBE_NAMESPACE --version $HELM_VERSION --create-namespace $HELM_SET
      fi
  rules:
    - if: $CI_COMMIT_TAG
      when: manual
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
      when: manual
    - when: never

.helm_rollback:
  stage: rollback
  before_script:
    - echo "${KUBE_CONFIG_BASE64}" | base64 -d > kubeconfig
    - export KUBECONFIG=$CI_PROJECT_DIR/kubeconfig
  script:
    >-
      helm rollback $HELM_RELEASE_NAME -n $KUBE_NAMESPACE
  rules:
    - if: $CI_COMMIT_TAG
      when: manual
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
      when: manual
    - when: never